<mat-card>
  <mat-card-content>
    @if (loading()) {
      <div class="loading-container">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Loading items...</p>
      </div>
    } @else if (error()) {
      <div class="error-container">
        <mat-icon>error_outline</mat-icon>
        <p>{{ error() }}</p>
      </div>
    } @else if (items().length === 0) {
      <div class="empty-container">
        <mat-icon>inbox</mat-icon>
        <p>No items found</p>
        <p class="hint">Upload some PDF invoices to see items here!</p>
      </div>
    } @else {
      <div class="table-container" (scroll)="onScroll($event)">
        <table mat-table [dataSource]="sortedItems()" class="item-table">
          <!-- Sr No Column -->
          <ng-container matColumnDef="sr">
            <th mat-header-cell *matHeaderCellDef>Sr</th>
            <td mat-cell *matCellDef="let item">
              <div class="sr-no">{{ item.sr }}</div>
            </td>
          </ng-container>

          <!-- Delivery Partner Column -->
          <ng-container matColumnDef="delivery_partner">
            <th mat-header-cell *matHeaderCellDef [attr.aria-sort]="getAriaSort('delivery_partner')">
              <div 
                class="sortable-content" 
                tabindex="0" 
                role="button" 
                (click)="toggleSort('delivery_partner')" 
                (keydown.enter)="toggleSort('delivery_partner')" 
                (keydown.space)="toggleSort('delivery_partner')">
                <span>Partner</span>
                <mat-icon>{{ getSortIcon('delivery_partner') }}</mat-icon>
              </div>
            </th>
            <td mat-cell *matCellDef="let item">
              <div class="partner-name">{{ item.delivery_partner || 'N/A' }}</div>
            </td>
          </ng-container>

          <!-- Date Column -->
          <ng-container matColumnDef="date">
            <th mat-header-cell *matHeaderCellDef [attr.aria-sort]="getAriaSort('date')">
              <div 
                class="sortable-content" 
                tabindex="0" 
                role="button" 
                (click)="toggleSort('date')" 
                (keydown.enter)="toggleSort('date')" 
                (keydown.space)="toggleSort('date')">
                <span>Date</span>
                <mat-icon>{{ getSortIcon('date') }}</mat-icon>
              </div>
            </th>
            <td mat-cell *matCellDef="let item">
              {{ formatDate(item.date) }}
            </td>
          </ng-container>

          <!-- Invoice Number Column -->
          <ng-container matColumnDef="invoice_no">
            <th mat-header-cell *matHeaderCellDef>Invoice No</th>
            <td mat-cell *matCellDef="let item">
              <div class="invoice-no">{{ item.invoice_no || 'N/A' }}</div>
            </td>
          </ng-container>

          <!-- Order Number Column -->
          <ng-container matColumnDef="order_no">
            <th mat-header-cell *matHeaderCellDef>Order No</th>
            <td mat-cell *matCellDef="let item">
              <div class="order-no">{{ getOrderNoDisplay(item.order_no) }}</div>
            </td>
          </ng-container>

          <!-- Description Column -->
          <ng-container matColumnDef="description">
            <th mat-header-cell *matHeaderCellDef>Name</th>
            <td mat-cell *matCellDef="let item">
              <div class="item-description" [matTooltip]="item.description">
                {{ item.description }}
              </div>
            </td>
          </ng-container>

          <!-- Quantity Column -->
          <ng-container matColumnDef="qty">
            <th mat-header-cell *matHeaderCellDef [attr.aria-sort]="getAriaSort('qty')">
              <div 
                class="sortable-content" 
                tabindex="0" 
                role="button" 
                (click)="toggleSort('qty')" 
                (keydown.enter)="toggleSort('qty')" 
                (keydown.space)="toggleSort('qty')">
                <span>Qty</span>
                <mat-icon>{{ getSortIcon('qty') }}</mat-icon>
              </div>
            </th>
            <td mat-cell *matCellDef="let item">
              {{ item.qty }}
            </td>
          </ng-container>

          <!-- Unit Price Column -->
          <ng-container matColumnDef="unit_price">
            <th mat-header-cell *matHeaderCellDef [attr.aria-sort]="getAriaSort('unit_price')">
              <div 
                class="sortable-content" 
                tabindex="0" 
                role="button" 
                (click)="toggleSort('unit_price')" 
                (keydown.enter)="toggleSort('unit_price')" 
                (keydown.space)="toggleSort('unit_price')">
                <span>Unit Price</span>
                <mat-icon>{{ getSortIcon('unit_price') }}</mat-icon>
              </div>
            </th>
            <td mat-cell *matCellDef="let item">
              <div class="unit-price">₹{{ (item.unit_price || 0).toFixed(2) }}</div>
            </td>
          </ng-container>

          <!-- Price Column -->
          <ng-container matColumnDef="price">
            <th mat-header-cell *matHeaderCellDef [attr.aria-sort]="getAriaSort('price')">
              <div 
                class="sortable-content" 
                tabindex="0" 
                role="button" 
                (click)="toggleSort('price')" 
                (keydown.enter)="toggleSort('price')" 
                (keydown.space)="toggleSort('price')">
                <span>Price</span>
                <mat-icon>{{ getSortIcon('price') }}</mat-icon>
              </div>
            </th>
            <td mat-cell *matCellDef="let item">
              <div class="total-amount">₹{{ (item.price || 0).toFixed(2) }}</div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
          <tr mat-row *matRowDef="let item; columns: displayedColumns;" class="item-row"></tr>
        </table>

        @if (loadingMore()) {
          <div class="loading-more">
            <mat-spinner diameter="30"></mat-spinner>
            <span>Loading more...</span>
          </div>
        }

        @if (!hasMore() && items().length > 0) {
          <div class="end-of-list">
            <span>All {{ total() }} items loaded</span>
          </div>
        }
      </div>
    }
  </mat-card-content>
</mat-card>
