<mat-card>
  <mat-card-content>
    @if (loading()) {
      <div class="loading-container">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Loading invoices...</p>
      </div>
    } @else if (error()) {
      <div class="error-container">
        <mat-icon>error_outline</mat-icon>
        <p>{{ error() }}</p>
      </div>
    } @else if (invoices().length === 0) {
      <div class="empty-container">
        <mat-icon>inbox</mat-icon>
        <p>No invoices found</p>
        <p class="hint">Upload some PDF invoices to get started!</p>
      </div>
    } @else {
      <div class="table-container">
        <!-- Header table (kept outside viewport so it doesn't get transformed) -->
        <table class="invoice-table header-table">
          <thead>
            <tr>
              <th>Order No</th>
              <th>Invoice No</th>
              <th [attr.aria-sort]="getAriaSort('date')">
                <app-column-header-menu label="Date" [active]="isColumnActive('date')" (open)="openDateDialog()"></app-column-header-menu>
              </th>
              <th [attr.aria-sort]="getAriaSort('delivery_partner')">
                <app-column-header-menu label="Partner" [active]="isColumnActive('delivery_partner')" (open)="openPartnerDialog()"></app-column-header-menu>
              </th>
              <th [attr.aria-sort]="getAriaSort('items_count')">
                <app-column-header-menu label="Items" [active]="isColumnActive('items_count')" (open)="openItemsCountDialog()"></app-column-header-menu>
              </th>
              <th [attr.aria-sort]="getAriaSort('total')">
                <app-column-header-menu label="Total" [active]="isColumnActive('total')" (open)="openTotalDialog()"></app-column-header-menu>
              </th>
              @if (showUploader) {
                <th>Uploaded By</th>
              }
              <th>Actions</th>
            </tr>
          </thead>
        </table>

        <cdk-virtual-scroll-viewport
          class="viewport"
          [itemSize]="rowHeightPx"
          [style.height.px]="viewportHeightPx">
          <table class="invoice-table body-table">
            <tbody>
              <tr *cdkVirtualFor="let invoice of invoices(); trackBy: trackById" class="invoice-row">
                <td><div class="order-no">{{ getOrderNoDisplay(invoice.order_no) }}</div></td>
                <td><div class="invoice-no">{{ invoice.invoice_no || 'N/A' }}</div></td>
                <td>{{ formatDate(invoice.date) }}</td>
                <td><div class="partner-name">{{ invoice.delivery_partner?.known_name || 'N/A' }}</div></td>
                <td>{{ invoice.items.length }}</td>
                <td><div class="total-amount">â‚¹{{ (invoice.items_total || 0).toFixed(2) }}</div></td>
                @if (showUploader) {
                  <td>{{ invoice.username || 'N/A' }}</td>
                }
                <td class="actions-cell">
                  <button mat-icon-button matTooltip="Details" (click)="openInvoiceItems(invoice, $event)">
                    <mat-icon>list</mat-icon>
                  </button>
                  <button mat-icon-button color="warn" matTooltip="Delete" (click)="deleteInvoice(invoice, $event)">
                    <mat-icon>delete</mat-icon>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </cdk-virtual-scroll-viewport>
        @if (loadingMore()) {
          <div class="loading-more">
            <mat-spinner diameter="30"></mat-spinner>
            <span>Loading more...</span>
          </div>
        }

        @if (!hasMore() && invoices().length > 0) {
          <div class="end-of-list">
            <span>All {{ total() }} invoices loaded</span>
          </div>
        }
      </div>
    }
  </mat-card-content>
</mat-card>

