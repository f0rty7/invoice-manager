<mat-card>
  <mat-card-content>
    @if (loading()) {
      <div class="loading-container">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Loading items...</p>
      </div>
    } @else if (error()) {
      <div class="error-container">
        <mat-icon>error_outline</mat-icon>
        <p>{{ error() }}</p>
      </div>
    } @else if (items().length === 0) {
      <div class="empty-container">
        <mat-icon>inbox</mat-icon>
        <p>No items found</p>
        <p class="hint">Upload some PDF invoices to see items here!</p>
      </div>
    } @else {
      <div class="table-container">
        <table class="item-table header-table">
          <thead>
            <tr>
              <th [attr.aria-sort]="getAriaSort('delivery_partner')">
                <app-column-header-menu label="Partner" [active]="isColumnActive('delivery_partner')" (open)="openPartnerDialog()"></app-column-header-menu>
              </th>
              <th [attr.aria-sort]="getAriaSort('date')">
                <app-column-header-menu label="Date" [active]="isColumnActive('date')" (open)="openDateDialog()"></app-column-header-menu>
              </th>
              <th>Order No</th>
              <th>Name</th>
              <th [attr.aria-sort]="getAriaSort('category')">
                <app-column-header-menu label="Category" [active]="isColumnActive('category')" (open)="openCategoryDialog()"></app-column-header-menu>
              </th>
              <th [attr.aria-sort]="getAriaSort('qty')">
                <app-column-header-menu label="Qty" [active]="isColumnActive('qty')" (open)="openQtyDialog()"></app-column-header-menu>
              </th>
              <th [attr.aria-sort]="getAriaSort('price')">
                <app-column-header-menu label="Price" [active]="isColumnActive('price')" (open)="openPriceDialog()"></app-column-header-menu>
              </th>
            </tr>
          </thead>
        </table>

        <cdk-virtual-scroll-viewport
          class="viewport"
          [itemSize]="rowHeightPx"
          [style.height.px]="viewportHeightPx">
          <table class="item-table body-table">
            <tbody>
              <tr *cdkVirtualFor="let item of items(); trackBy: trackByItem" class="item-row">
                <td><div class="partner-name">{{ item.delivery_partner || 'N/A' }}</div></td>
                <td>{{ formatDate(item.date) }}</td>
                <td><div class="order-no">{{ getOrderNoDisplay(item.order_no) }}</div></td>
                <td><div class="item-description" [matTooltip]="item.description">{{ item.description }}</div></td>
                <td><div class="category">{{ item.category || 'N/A' }}</div></td>
                <td>{{ item.qty }}</td>
                <td><div class="total-amount">₹{{ (item.price || 0).toFixed(2) }}</div></td>
              </tr>
            </tbody>
          </table>
        </cdk-virtual-scroll-viewport>

        <div class="table-footer">
          <div class="footer-left">
            Total (filtered): <strong>₹{{ (aggregate()?.total_price || 0).toFixed(2) }}</strong>
          </div>
          <div class="footer-right">
            Count: <strong>{{ aggregate()?.total_count || 0 }}</strong>
          </div>
        </div>

        @if (loadingMore()) {
          <div class="loading-more">
            <mat-spinner diameter="30"></mat-spinner>
            <span>Loading more...</span>
          </div>
        }

        @if (!hasMore() && items().length > 0) {
          <div class="end-of-list">
            <span>All {{ total() }} items loaded</span>
          </div>
        }
      </div>
    }
  </mat-card-content>
</mat-card>
